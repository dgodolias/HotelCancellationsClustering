# Αναφορά Ομαδοποίησης Ακυρώσεων Ξενοδοχείων
Δημοσθένης Παναγιώτης Γκοντολιας (ΑΜ: 3220031)

## 1. Επισκόπηση Εργασίας
Ο στόχος αυτής της εργασίας είναι η ανάλυση δεδομένων κρατήσεων ξενοδοχείων για τον εντοπισμό διακριτών clusters πελατών με βάση τις συμπεριφορές και τα χαρακτηριστικά των κρατήσεών τους. Κατανοώντας αυτά τα τμήματα, στοχεύουμε να αποκτήσουμε γνώσεις σχετικά με τα μοτίβα ακυρώσεων.

## 2. Μεθοδολογία

### Feature Engineering
Παραγάγαμε αρκετά βασικά χαρακτηριστικά για την καλύτερη αποτύπωση της συμπεριφοράς των πελατών:
- **Arrival Month**: Υπολογίστηκε για την αποτύπωση της εποχικότητας.
- **Total Guests**: Άθροισμα ενηλίκων και παιδιών.
- **Is Family**: Binary feature για κρατήσεις με παιδιά.
- **Total Nights**: Άθροισμα διανυκτερεύσεων καθημερινών και σαββατοκύριακων.
- **Cancellation Ratio**: Μια αναλογία προηγούμενων ακυρώσεων για επαναλαμβανόμενους πελάτες με εξομάλυνση Laplace.
- **Price per Person**: Μέση τιμή διαιρεμένη με το σύνολο των επισκεπτών.
- **Meal Type & Room Type**: Αρχικά δημιουργήθηκαν κατηγορικές μεταβλητές για τον τύπο γεύματος και δωματίου.
- **Encoding**: Εφαρμογή one-hot encoding σε κατηγορικές μεταβλητές (`market.segment.type`, `room.type`, `type.of.meal`) για τους λόγους ότι οι τιμές της ειναι strings και δεν υπάρχει η έννοια της απόστασης. Όμως και ως αριθμητικές τιμές να τις αντιπροσωπεύσουμε, πάλι δεν έχει νόημα η ευκλέιδια απόσταση πχ να μην θεωρησει οτι το 2 ειναι πιο κοντα στο 1 απο το 3.
    - **Room Type**: `room.type_Room_Type 2` έως `room.type_Room_Type 7`
    - **Meal Type**: `type.of.meal_Meal Plan 2` έως `type.of.meal_Meal Plan 3`
    - **Market Segment**: `market.segment.type_Complementary`, `market.segment.type_Corporate`, `market.segment.type_Offline`, `market.segment.type_Online`
- **Drop First**: Ορισμός του `drop_first=True` για να αποφύγουμε το dummy variable trap. Για αυτόν τον λόγο δεν έχουν χρησιμοποιηθεί `room.type_Room_Type 1`, `type.of.meal_Meal Plan 1`, `market.segment.type_Aviation`.

### Preprocessing
- **Data Cleaning**: Χειρισμός μη έγκυρων ημερομηνιών και ελλειπών τιμών.
- **Binning**: Ομαδοποίηση σπάνιων τιμών σε χαρακτηριστικά όπως `number.of.children`, `Total_Guests` και `Total_Nights` για μείωση του θορύβου:
#### Μεταβλητές με Binning:
1. **number.of.children**: 0, 1+ (αντί για 0, 1, 2, 3, κλπ)
2. **number.of.weekend.nights**: 0, 1, 2, 3+
3. **number.of.week.nights**: Κανονικά ως το 5, μετά 6+
4. **P.C (Previous Cancellations)**: 0, 1+
5. **P.not.C (Previous Non-Cancellations)**: 0, 1+
6. **Total_Guests**: 1, 2, 3+
   - Όσα είναι 0 γίνονται 1 (διόρθωση)
7. **Total_Nights**: Κανονικά ως το 7, μετά 8+

- **Scaling**: Κανονικοποίηση αριθμητικών χαρακτηριστικών στο εύρος [-1, 1] για να διασφαλιστεί η ίση συμβολή στους υπολογισμούς αποστάσεων, αφού υπάρχουν αριθμητικές τιμές που είναι πολύ μεγαλύτερες απο τις άλλες. Έτσι, δεν θα δωθεί περισσότερη βαρύτητα σε μια μεταβλητή λόγω των μεγάλων τιμών. 
- Παραδειγμα, μια παρατηρηση με lead.time=100 & total.guests=2 θα είναι πιο κοντά στην παρατήρηση με lead.time=100 & total.guests=5, παρά την παρατήρηση με lead.time=105 & total.guests=2.

### Clustering
Χρησιμοποιήσαμε δύο κύριους αλγόριθμους clustering για να εξασφαλίσουμε την εγκυρότητα των αποτελεσμάτων:

1. **K-Means Clustering**:
   - **Λειτουργία**: Ένας επαναληπτικός αλγόριθμος που χωρίζει τα δεδομένα σε $k$ ομάδες, ελαχιστοποιώντας την απόσταση των σημείων από το κέντρο της ομάδας τους (centroid).
   - **Παράμετροι**:
     - `centers = k`: Ο αριθμός των ομάδων που δοκιμάσαμε (από 2 έως 10).
     - `nstart = 10`: Ο αλγόριθμος έτρεξε 10 φορές με τυχαία αρχικά κέντρα για να αποφύγουμε τοπικά ελάχιστα και να διασφαλίσουμε τη σταθερότητα της λύσης.
   - **Απόσταση**: Ευκλείδεια απόσταση.

2. **Hierarchical Clustering**:
   - **Λειτουργία**: Κατασκευάζει μια ιεραρχία ομάδων συγχωνεύοντας σταδιακά τα πιο κοντινά σημεία.
   - **Linkage**: `ward.D2`. Η μέθοδος Ward ελαχιστοποιεί τη διακύμανση μέσα στις ομάδες κατά τη συγχώνευση, οδηγώντας σε συμπαγείς και σφαιρικές ομάδες, παρόμοιες με αυτές του K-Means.
   - **Απόσταση**: Ευκλείδεια απόσταση.

## 3. Ανάλυση & Βελτιστοποίηση

### Καθορισμός Βέλτιστου k
Αξιολογήσαμε τον αριθμό των ομάδων k χρησιμοποιώντας Silhouette Score, Elbow Method, NMI και ARI.
- Η αρχική ανάλυση πρότεινε k=3, αλλά περαιτέρω βελτιστοποίηση αποκάλυψε μια ισχυρότερη δομή στο **k=4**.

### Feature Elimination (Stepwise Process)
Η διαδικασία επιλογής χαρακτηριστικών έγινε βηματικά (stepwise), αφαιρώντας μεταβλητές που πρόσθεταν θόρυβο και χειροτέρευαν το Silhouette Score για $k=3$. Παρατηρήσαμε ότι καθώς αφαιρούσαμε τον θόρυβο, οι μετρικές γίνονταν πιο "σίγουρες", αλλά το βέλτιστο $k$ μετατοπίστηκε από το 3 στο 4, γεγονός ιδιαίτερα ενδιαφέρον.

*Σημείωση: Οι δοκιμές με stepwise και η αρχική επιλογή μεταβλητών πραγματοποιήθηκαν προσωπικά σε Python για διευκόλυνση, καθώς είμαι φοιτητής πληροφορικής. Για αυτόν τον λόγο, τα γραφήματα στα βήματα 1-4 αυτής της ενότητας έχουν διαφορετικά χρώματα και τεχνικά χαρακτηριστικά από το τελικό γράφημα αξιολόγησης ομαδοποίησης, το οποίο δημιουργήθηκε σε R. Η τελική εργασία, ωστόσο με βαση τις ακαδημαικές οδηγίες, υλοποιήθηκε πλήρως σε R και ο κώδικας έχει παρατεθεί για επιβεβαίωση.*

Η εξέλιξη της βελτίωσης φαίνεται στα παρακάτω βήματα:

1.  **Step 1 (Initial State)**: Όλες οι μεταβλητές συμπεριλαμβανομένων των `meal type` και `room type`, χωρίς scaling.
    ![Output 1 - Initial](R/old_visuals/output1.png)
    *Εδώ παρατηρούμε χαμηλό διαχωρισμό.*

2.  **Step 2 (Scaling)**: Εφαρμογή scaling στις μεταβλητές.
    ![Output 2 - Scaled](R/old_visuals/output2.png)
    *Παρατηρήθηκε εμφανής βελτίωση στη δομή των ομάδων.*

3.  **Step 3 (Categorical Removal)**: Αφαίρεση των κατηγορικών μεταβλητών που προέκυψαν από `type.of.meal` και `room.type` για μείωση θορύβου.
    ![Output 3 - No Categoricals](R/old_visuals/output3.png)

4.  **Step 4 (Temporal Removal)**: Αφαίρεση των μεταβλητών `arrival.year` και `date.of.reservation`.
    ![Output 4 - Final](R/old_visuals/output4.png)

5.  **Step 5 (Arrival_Month Removal)**:
    - **Παρατήρηση**: Οι μέσες τιμές του `Arrival_Month` σε όλα τα 4 clusters ήταν πολύ κοντά στο 6 (range: 6.41-6.67)
    - **Feature Elimination Analysis**: Η αφαίρεση του `Arrival_Month` ανέβαζε το Silhouette περισσότερο από οποιαδήποτε άλλη μεταβλητή
    - **Συμπέρασμα**: Το `Arrival_Month` είναι θόρυβος και δεν συμβάλλει στον διαχωρισμό των clusters
    - **Ενέργεια**: Αφαιρέθηκε το `Arrival_Month`
    
    ![Τελική Αξιολόγηση](R/visuals/clustering_evaluation.png)
    *Η τελική μορφή όπου αναδείχθηκε το k=4 ως βέλτιστη λύση.*

### Σύγκριση Αλγορίθμων
Για να επιβεβαιώσουμε τη σταθερότητα των ομάδων, συγκρίναμε τα αποτελέσματα του K-Means με αυτά της Ιεραρχικής Ομαδοποίησης χρησιμοποιώντας τους δείκτες **NMI** και **ARI**.

| k | NMI | ARI | Σχόλια |
|---|---|---|---|
| 2 | 0.9299 | 0.9661 | Υψηλή συμφωνία |
| 3 | 0.9652 | 0.9824 | Πολύ υψηλή συμφωνία |
| **4** | **0.9755** | **0.9884** | **Εξαιρετικά μέγιστη συμφωνία - Βέλτιστη λύση** |
| 5 | 0.7611 | 0.6187 | Σημαντική πτώση στη συμφωνία |

Η εξαιρετικά υψηλή τιμή των δεικτών για $k=4$ (NMI > 0.97, ARI > 0.98) υποδεικνύει ότι και οι δύο αλγόριθμοι εντοπίζουν σχεδόν την ίδια δομή στα δεδομένα, ενισχύοντας την εμπιστοσύνη μας στην επιλογή των 4 ομάδων.

**Τελικά Αποτελέσματα (k=4):**
- **Silhouette Score**: ~0.49 (Υψηλή ποιότητα)
- **NMI / ARI**: > 0.97 (Εξαιρετική συμφωνία μεταξύ K-Means και Ιεραρχικής)

## 4. Cluster Profiles

Με βάση την τελική ομαδοποίηση, εντοπίσαμε 4 διακριτά προφίλ πελατών. Θα επιχειρήσουμε να τα ονοματοδοτήσουμε κατάλληλα και να τα παρατηρήσουμε. Για την επιβεβαίωση των βασικών χαρακτηριστικών των ομάδων, ανατρέξτε στο heatmap που βρίσκεται στο section 5(Οπτικοποιήσεις):

### Cluster 0: Τυπικά Online Ζευγάρια
- **Προφίλ**: Ζευγάρια που ταξιδεύουν για αναψυχή.
- **Βασικά Χαρακτηριστικά**: 2 ενήλικες, 0 παιδιά, υψηλή τιμή ανά άτομο.
- **Κανάλι Κράτησης**: Αποκλειστικά **Online**.
- **Ρίσκο**: Υψηλό ποσοστό ακύρωσης (~37%).
- **Εξήγηση**: Οι Online κρατήσεις (Booking, Expedia etc) έχουν συνήθως δωρεάν ακύρωση και γίνονται με ένα κλικ. Οι τουρίστες αναψυχής συχνά κλείνουν "για να έχουν κάτι σίγουρο" (backup booking, το εχω κάνει πάμπολες φορές) και συνεχίζουν να ψάχνουν. Αν βρουν κάτι φθηνότερο ή πιο κεντρικό, ακυρώνουν χωρίς δεύτερη σκέψη.

### Cluster 1: Offline / Early Birds
- **Προφίλ**: Ταξιδιώτες μεγαλύτερης ηλικίας ή γκρουπ που προγραμματίζουν πολύ νωρίτερα.
- **Βασικά Χαρακτηριστικά**: Μεγαλύτερος **Χρόνος Προετοιμασίας (Lead Time)**, χαμηλότερη μέση τιμή.
- **Κανάλι Κράτησης**: **Offline** (Ταξιδιωτικοί Πράκτορες/Τηλέφωνο).
- **Ρίσκο**: Μεσαίο-Υψηλό ποσοστό ακύρωσης (~30%).
- **Εξήγηση**: Είναι χαμηλότερο από το Cluster 0 γιατί η Offline κράτηση (τηλέφωνο/πρακτορείο) δημιουργεί μια δέσμευση. Δεν ακυρώνεις τόσο εύκολα όσο με ένα κλικ στο κινητό και δεν έχει συνήθως δωρεάν ακύρωση. Μπορεί να υπάρχει κάποιο πέναλτι. Παραμένει όμως υψηλό γιατί, όπως είδαμε στο Heatmap, έχουν το μεγαλύτερο Lead Time. Όταν κλείνεις μήνες πριν, η πιθανότητα να αλλάξουν τα σχέδιά σου είναι στατιστικά μεγάλη.

### Cluster 2: Premium Οικογένειες
- **Προφίλ**: Οικογένειες σε διακοπές.
- **Βασικά Χαρακτηριστικά**: Παρουσία **παιδιών**, υψηλότερη συνολική τιμή, τα περισσότερα ειδικά αιτήματα.
- **Κανάλι Κράτησης**: **Online**.
- **Ρίσκο**: Υψηλότερο ποσοστό ακύρωσης (~40%) λόγω πολυπλοκότητας του οικογενειακού ταξιδιού και των απροβλεπτων που μπορούν να προκύψουν για ένα μέλος της οικογένειας, το οποίο θα αναγκάσει ολόκληρη την οικογένεια να ακυρώσει.
- **Εξήγηση**: 
    - ***Απρόοπτα:*** Όταν ταξιδεύουν παιδιά, είναι πολύ συχνό να προκύψει μια ασθένεια ή αλλαγή προγράμματος τελευταία στιγμή.
    - ***Κόστος:*** Επειδή είναι η πιο ακριβή ομάδα (High Price), οι γονείς συχνά ψάχνουν μέχρι τελευταία στιγμή για καλύτερη προσφορά (deal hunting) και αν τη βρουν, ακυρώνουν την αρχική.
    - ***Lead Time:*** Οι οικογενειακές διακοπές οργανώνονται νωρίς, δίνοντας μεγάλο χρονικό περιθώριο για να πάει κάτι στραβά.

### Cluster 3: Πιστοί Εταιρικοί Πελάτες (Loyal Corporate)
- **Προφίλ**: Επαγγελματίες ταξιδιώτες και συχνοί επισκέπτες.
- **Βασικά Χαρακτηριστικά**: **Επαναλαμβανόμενοι** επισκέπτες, ιστορικό μη ακυρώσεων, ανάγκη για πάρκινγκ.
- **Κανάλι Κράτησης**: **Corporate**, Aviation, Complementary.
- **Ρίσκο**: Χαμηλότερο ποσοστό ακύρωσης (~11%).
- **Εξήγηση**: Αυτό είναι το πιο "λογικό" νούμερο. Όπως είδαμε, αυτή η ομάδα περιλαμβάνει εταιρικούς πελάτες και επαναλαμβανόμενους επισκέπτες. Οι επαγγελματίες ταξιδεύουν για συγκεκριμένο σκοπό (δουλειά) και σπάνια ακυρώνουν. Επίσης, οι "Repeaters" είναι πιστοί πελάτες που ξέρουν το ξενοδοχείο και δεν κάνουν δοκιμαστικές κρατήσεις για να τις ακυρώσουν μετά. Είναι η "σταθερά" του ξενοδοχείου.

## 5. Οπτικοποιήσεις

### Κατανομές Χαρακτηριστικών
![Πλέγμα Κατανομών 1](R/visuals/dist_grid_1.png)
![Πλέγμα Κατανομών 2](R/visuals/dist_grid_2.png)
![Πλέγμα Κατανομών 3](R/visuals/dist_grid_3.png)
![Πλέγμα Κατανομών 4](R/visuals/dist_grid_4.png)

### Κατανομή Market Segment
![Κατανομή Market Segment Type](R/visuals/dist_market_segment.png)

### Συγκρίσεις Ομάδων
![Πλέγμα Συγκρίσεων Ομάδων 1](R/visuals/cluster_comp_grid_1.png)
![Πλέγμα Συγκρίσεων Ομάδων 2](R/visuals/cluster_comp_grid_2.png)
![Πλέγμα Συγκρίσεων Ομάδων 3](R/visuals/cluster_comp_grid_3.png)
![Πλέγμα Συγκρίσεων Ομάδων 4](R/visuals/cluster_comp_grid_4.png)

### Σύγκριση Market Segment ανά Cluster
![Market Segment ανά Cluster](R/visuals/cluster_comp_market_segment.png)

### Heatmap
![Heatmap](R/visuals/cluster_heatmap.png)

### Ποσοστά Ακυρώσεων
![Ποσοστά Ακυρώσεων](R/visuals/cancellation_rate.png)

## 6. Συμπέρασμα

Η ανάλυση clustering αποκάλυψε επιτυχώς **4 διακριτά προφίλ πελατών** με σημαντικές διαφορές στη συμπεριφορά κράτησης και το ρίσκο ακύρωσης. Η μεθοδολογία που ακολουθήθηκε—συνδυασμός K-Means και Hierarchical Clustering με βηματική αφαίρεση θορυβωδών μεταβλητών—οδήγησε σε εξαιρετικά υψηλή συμφωνία μεταξύ των αλγορίθμων (NMI > 0.97, ARI > 0.98), επιβεβαιώνοντας την εγκυρότητα των αποτελεσμάτων.

### Βασικά Ευρήματα

1. **Ποιότητα Clustering**: Το τελικό Silhouette Score (~0.49) υποδεικνύει ισχυρό διαχωρισμό των ομάδων, ενώ η σταδιακή βελτίωση από 0.27 (αρχικά) σε 0.49 (τελικά) αποδεικνύει τη σημασία της προσεκτικής επιλογής χαρακτηριστικών.

2. **Διαφοροποίηση Ρίσκου**: Τα ποσοστά ακύρωσης κυμαίνονται από 11% (Corporate) έως 40% (Families), δημιουργώντας σαφείς κατηγορίες ρίσκου που επιτρέπουν στοχευμένες στρατηγικές.

3. **Κανάλι vs Ρίσκο**: Οι Online κρατήσεις (Clusters 0, 2) παρουσιάζουν σταθερά υψηλότερα ποσοστά ακύρωσης (37-40%) σε σχέση με Offline/Corporate (11-30%), υποδεικνύοντας τη σημασία του καναλιού κράτησης.

### Πρακτικές Εφαρμογές

Τα αποτελέσματα επιτρέπουν την ανάπτυξη **διαφοροποιημένων στρατηγικών** ανά cluster, για να αποτραπεί οσο το δυνατόν περισσότερο ο κίνδυνος των ακυρώσεων (δεν ζητείται απο εκφώνηση, αλλα παρατίθεται):

- **Cluster 3 (Corporate)**: Προτεραιότητα σε loyalty programs και εταιρικά πακέτα για διατήρηση αυτής της σταθερής βάσης εσόδων.
- **Clusters 0 & 2 (High Risk)**: Εφαρμογή μη επιστρεπτέων τιμών, προκαταβολών, ή ειδικών εκπτώσεων για early check-in/late cancellation.
- **Cluster 1 (Offline/Early Birds)**: Στόχευση με early booking discounts για μετατροπή του μεγάλου lead time σε πλεονέκτημα.

### Τελική Παρατήρηση

Η ανάλυση αποδεικνύει ότι **το κανάλι κράτησης, η σύνθεση της ομάδας (οικογένεια vs ζευγάρι vs εταιρικό), και ο χρόνος προετοιμασίας** είναι οι κρισιμότεροι παράγοντες που καθορίζουν τη συμπεριφορά ακύρωσης. Αντίθετα, χαρακτηριστικά όπως `room.type`, `meal.type`, και `arrival.month` αποδείχθηκαν θόρυβος, υπογραμμίζοντας τη σημασία του feature selection στην ποιότητα του clustering.
